<h1>아이돌 목록</h1>

<form method="get" action="">
    <input type="text" name="search" placeholder="아이돌 이름 검색" value="{{ search_query }}">
    <button type="submit">검색</button>
</form>

{% if user.is_authenticated %}
    <ul id="idol-list">
        {% for idol in idols %}
            <li>
                <a href="/test/idols/{{ idol.id }}/" style="text-decoration: none; color: black;">{{ idol.name }}</a>
                <button type="button" class="bookmark-button" data-idol-id="{{ idol.id }}" data-action="{% if idol.is_bookmarked %}remove{% else %}add{% endif %}">
                    {% if idol.is_bookmarked %}북마크 해제{% else %}북마크 추가{% endif %}
                </button>
                <form class="bookmark-form" method="post" action="/test/bookmark_idol/{{ idol.id }}/" style="display:none;">
                    {% csrf_token %}
                </form>
            </li>
        {% empty %}
            <li>아이돌이 없습니다.</li>
        {% endfor %}
    </ul>
{% else %}
    <p>로그인해야 아이돌 목록을 볼 수 있습니다.</p>
{% endif %}

<p><a href="/test/">메인으로 돌아가기</a></p>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const bookmarkButtons = document.querySelectorAll('.bookmark-button');

    bookmarkButtons.forEach(button => {
        button.addEventListener('click', function(event) {
            event.preventDefault(); // Prevent default button click behavior

            const idolId = this.dataset.idolId;
            let action = this.dataset.action;
            const url = `/test/bookmark_idol/${idolId}/`;
            const form = this.nextElementSibling; // Get the hidden form
            const csrfToken = form.querySelector('[name="csrfmiddlewaretoken"]').value;

            const formData = new FormData();
            formData.append('action', action);
            formData.append('csrfmiddlewaretoken', csrfToken);

            fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    if (data.action === 'added') {
                        button.textContent = '북마크 해제';
                        button.dataset.action = 'remove';
                    } else if (data.action === 'removed') {
                        button.textContent = '북마크 추가';
                        button.dataset.action = 'add';
                    }
                    console.log('Bookmark action successful:', data);
                } else {
                    alert('오류: ' + data.message);
                    console.error('Bookmark action failed:', data);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('네트워크 오류가 발생했습니다.');
            });
        });
    });
});
</script>
